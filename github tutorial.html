<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel J. Herrera, Daniel Levy, Austin M. Green, William F. Fagan">

<title>Estimating prey activity curves using a quantitative model based on a priori distributions and predator detection data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="github tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="github tutorial_files/libs/quarto-html/quarto.js"></script>
<script src="github tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="github tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="github tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="github tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="github tutorial_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="github tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="github tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="github tutorial_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Estimating prey activity curves using a quantitative model based on a priori distributions and predator detection data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel J. Herrera, Daniel Levy, Austin M. Green, William F. Fagan </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Ecologists routinely study the impact of predators on prey activity patterns through the largely qualitative approach of comparing overlapping activity density plots. While this method offers some insight into predator-prey dynamics, it does not actually quantify the degree to which a predator’s activity impacts prey activity. Here, we present a novel model that overcomes this shortcoming by using predator detections and an ideal prey activity curve to quantify the impact of predator activity on prey activity patterns. The model assumes that species strive to adhere to an ideal activity distribution and quantifies the degree to which a predator prompts a departure from this ideal curve. This approach improves our ability to quantify and predict predator-prey interactions as they pertain to activity patterns. For a more detailed justification, please see our paper published in Ecological Modelling (2024).</p>
</section>
<section id="model-structure" class="level2">
<h2 class="anchored" data-anchor-id="model-structure">Model Structure</h2>
<p>Our model is premised upon the idea that prey species try to adhere to a specific activity pattern in the absence of predators. Coincidentally, these patterns happen to resemble familiar data distributions. For instance, let’s assume that our prey species’ activity curve (blue) resembles the centered beta distribution (alpha = 2, beta = 2):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="github-tutorial_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Now let’s suppose a predator (red) is active during the same time period, but does not adhere to the same activity pattern as the prey.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="github-tutorial_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>The previous graph assumes that the prey (blue) is not impacted by the predator (red). But our model uses the proportional intensity of predator activity to alter the prey activity curve (with a lower bound of zero since negative activity is not possible). Additionally, the model acknowledges that prey will respond differently to various predators. Thus, we estimate the sensitivity (<em>s</em>) of the prey to the predator. If the prey is highly sensitive, then its activity curve will be more dampened than if the prey has a low sensitivity value. Here’s three different outcomes where <em>s</em> = 0.25 (top), 0.50 (middle), and 0.75 (bottom).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="github-tutorial_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Simply removing activity from the prey’s curve is not biologically realistic, however, since the animal still needs to be out foraging, searching for mates, etc. Thus, the model allows the prey to respond by compensating for activity lost earlier in the active period. Importantly, the model assumes compensation for lost activity becomes more important later in the active period since there are progressively fewer opportunities to make up for lost activity as the day goes on (assuming being active outside of the active period is not possible). In the following plot, the dashed blue line represents the prey’s activity when <em>s</em> = 0.25 and no lost activity is compensated for. The solid blue line represents the prey’s activity when <em>s</em> = 0.25 and lost activity is compensated for. Note that compensation attempts at time <em>t</em> seek to restore the realized activity curve to the ideal activity curve as some later time <em>t+x.</em> In other words, allowing for activity compensation reveals an activity curve that seeks to return (or closely resemble) the ideal a priori activity curve.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="github-tutorial_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="running-the-model-on-real-data" class="level2">
<h2 class="anchored" data-anchor-id="running-the-model-on-real-data">Running the model on real data</h2>
<p>The above plots were made using fictitious data, which aren’t particularly exciting or compelling. But our model allows for the estimation of <em>s</em> when using real data. To fit your own data to this model, be sure to download the functions script from the <em>code</em> folder and source the script so the functions exist in your environment.</p>
<p><code>source("./YOUR FILE PATH/activityFunctions.R")</code></p>
<p>You’ll want to use your own data, but for the sake of example we’ll use the data that we used in the paper. You can access the entire data set via <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecy.3353">Cove, et al.&nbsp;2019</a>, our you can access a miniature version of this data set using the <code>UtahData()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">UtahData</span>() <span class="co">#loads data into environment and names it "UtahData"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(UtahData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>            project                  array                    site
1 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
2 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
3 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
4 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
5 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
6 Snapshot USA 2019 Wasatch Wildlife Watch Creekside Park.USA.2019
             obs.time species
1 2019-09-11 03:07:00 Red Fox
2 2019-09-13 02:17:00 Red Fox
3 2019-09-16 00:35:00 Red Fox
4 2019-09-16 02:29:00 Red Fox
5 2019-09-16 05:33:00 Red Fox
6 2019-09-18 03:32:00 Red Fox</code></pre>
</div>
</div>
<p><em>Note that these observation times are already in “POSIXlt” format. Use the <code>strptime()</code> function to convert your own data’s timestamp column to “POSIXlt”</em> <em>format.</em></p>
<p><br></p>
<p>To convert observation timestamps into activity curves, use the <code>format_observedPDF()</code> function. If your goal is to predict prey distribution based on a known <em>s</em> value, you only need to use this function on the predator data. If <em>s</em> is unknown and you wish to estimate it, use this function for both predator and prey data. Note that <code>time.start</code> and <code>time.stop</code> must be the same across all species and functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cottontail <span class="ot">&lt;-</span> <span class="fu">format_observedPDF</span>(<span class="at">df =</span> UtahData, <span class="co">#name of data frame</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sp.col =</span> <span class="st">"species"</span>, <span class="co">#name of species column in data frame </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sp.name =</span> <span class="st">"Mountain Cottontail"</span>, <span class="co">#name of focal species</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.start =</span> <span class="st">"18:00"</span>, <span class="co">#start of active period as character without date</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.stop =</span> <span class="st">"12:00"</span>, <span class="co">#end of active period as character without date</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.col =</span> <span class="st">"obs.time"</span>) <span class="co">#name of column that holds observation time stamps</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>fox <span class="ot">&lt;-</span> <span class="fu">format_observedPDF</span>(<span class="at">df =</span> UtahData,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sp.col =</span> <span class="st">"species"</span>, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">sp.name =</span> <span class="st">"Red Fox"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.start =</span> <span class="st">"18:00"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.stop =</span> <span class="st">"12:00"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">time.col =</span> <span class="st">"obs.time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>To set up the a priori distribution, use the <code>format_idealPDF()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ideal.dist <span class="ot">&lt;-</span> <span class="fu">format_idealPDF</span>(<span class="at">time.start =</span> <span class="st">"18:00"</span>, <span class="co">#specify start of active period as character without date</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">time.stop =</span> <span class="st">"12:00"</span>, <span class="co">#specify end of active period as character without date</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">observedPDF =</span> cottontail, <span class="co">#specify observed activity distribution</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">dist =</span> <span class="st">"triangular"</span>, <span class="co">#specify distribution</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">param1 =</span> <span class="dv">0</span>, <span class="co">#various shape parameters governing the distribution (error messages will help you through these)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">param2 =</span> <span class="dv">1</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">param3 =</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>For simplicity, we will only make one a priori distribution here. But be sure to test several options in your own analysis (and read the paper to understand why). The <code>format_idealPDF()</code> function offers a number of different distributions that will seamlessly work with the other functions included in this script. To see which pre-set distributions are possible, feed the function any value that you know isn’t a distribution to throw a helpful error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ideal.dist <span class="ot">&lt;-</span> <span class="fu">format_idealPDF</span>(<span class="at">time.start =</span> <span class="st">"18:00"</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">time.stop =</span> <span class="st">"12:00"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">observedPDF =</span> cottontail,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">dist =</span> <span class="st">"i don't know"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>the following shapes are permissable (but custom shapes can be used as long as the vector length matches that of the disturbance vector and the vector sums to 1): beta, binomial, bimodal, kumaraswamy, normal, triangular, uniform.</code></pre>
</div>
</div>
<p><br></p>
<p>Now that we have our ideal a priori distribution, as well as our observed distributions for both predator and prey, we can estimate the sensitivity of the prey to the predator using the <code>estimate_activity()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pred.list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co">#create an empty list</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pred.list[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> fox <span class="co">#fill the first slot of the list with fox data</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">estimate_activity</span>(<span class="at">idealPDF =</span> ideal.dist, <span class="co">#specify ideal a priori distribution</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">disturbance =</span> pred.list, <span class="co">#specify list of predator activity distributions (even if only one predator)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">observedPDF =</span> cottontail, <span class="co">#specify observed prey activity distribution</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">confInt =</span> <span class="cn">TRUE</span>, <span class="co">#indicate that we want to calculate a confidence interval</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nIter =</span> <span class="dv">1000</span>, <span class="co">#specify the number of iterations to bootstrap over (this can take a while, so be patient or pick a small number)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">AIC =</span> <span class="cn">TRUE</span>) <span class="co">#instruct R to calcualte AIC score (only useful if comparing models)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>          S              CI95     negLL      AIC
 0.09791847 (0.0884 - 0.1145) -531.6364 1081.273</code></pre>
</div>
</div>
<p><br></p>
<p>While plotting activity curves can be useful, the above-printed results are the real pride of this model. Recall that <em>s</em> is the sensitivity of the prey to the predator. Rather than telling us the degree of overlap between the predator and prey activity curves, estimating <em>s</em> allows us to determine the degree to which the predator actually changes a prey’s activity. In other words, this method provides us mechanistic results rather than descriptive results.</p>
<p>That being said, we do still want to visualize our results. You can feed the estimated <em>s</em> value into a predictive model using the <code>predict_activity()</code> function. Similar to how predator activity curves must be provided as a list, sensitivity values do as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sens.list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sens.list[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fl">0.097</span> <span class="co">#value based on above estimation</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>pred.prediction <span class="ot">&lt;-</span> <span class="fu">predict_activity</span>(<span class="at">idealPDF =</span> ideal.dist, <span class="co">#specify a priori distribution </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">disturbance =</span> pred.list, <span class="co">#specify predator activity distribution(s) as a list</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">sensitivity =</span> sens.list) <span class="co">#specify sensitivity value(s) distributions as a list</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="github-tutorial_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is slightly different than the output you’ll see when using the functions on your own computer. Here, we see the ideal distribution (triangular distribution) in grey, the observed cottontail distribution in red, and the predicted cottontail distribution in blue. As you can see, the predicted line resembles the observed line, and sufficiently deviates from the a priori distribution. In other words, it works!</p>
<p>While this function will plot a rudamentary visualization in your plotting window, it will also save the results to your environment as a data frame (provided you run the function as a named object, eg. <code>name &lt;- function(arguments)</code>). You can then use that data frame to create a more robust visualization, which is what I have shown here.</p>
<p>We hope that this model suits your needs, and that the functions included in the <code>activityFunctions.R</code> script are flexible enough to meet your needs. Feel free to use this model as is, feed the model different types of data (e.g., precipitation data instead of predator data), or improve upon the model by including additional terms. Also, if you’re a better coder than I am, I would love help implementing a better likelihood estimator (the current estimator searches over values much faster than my homemade estimator could, but but crashes when I try to use two predator data sets in the same model)!</p>
<p>Finally, we encourage you to read the paper, and cite us if you decide on using this model. Please feel free to reach out if you have any questions or comments (herrerawildlife@gmail.com). You can also reach me via my <a href="https://www.herrerawildlife.com/">personal website</a>.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>